# 教师排名赋分计算器 - 运行程序说明

## 📋 程序概述

教师排名赋分计算器是一个用于计算教师教学成绩排名和赋分的Python程序。程序支持网页界面和命令行两种运行模式，能够自动处理Excel文件中的多个科目数据，计算各指标的排名、赋分和综合得分。程序具备智能数据清洗和容错处理能力，支持多种列名格式。

## 🚀 运行方式

### 方式1：网页界面（推荐）

#### 启动网页服务
```bash
# 快速启动
source .venv/bin/activate && python3 web_app.py

# 分步启动
# 激活虚拟环境
source .venv/bin/activate 

# 启动Web服务
python3 web_app.py
```

#### 访问地址
启动成功后，在浏览器中打开：
- **本地访问**：`http://localhost:8080` 或 `http://127.0.0.1:8080`
- **局域网访问**：`http://10.33.5.127:8080`

#### 操作步骤
1. **上传Excel文件**：点击"选择文件"按钮，选择包含教师数据的Excel文件
   - 支持格式：`.xls`、`.xlsx`
   - 文件大小限制：16MB

2. **选择处理科目**：
   - **所有科目**：处理Excel中的所有科目数据
   - **单个科目**：选择特定科目（语文、数学、英语、物理、化学、道法、历史、地理、生物、科学）

3. **开始处理**：点击"开始处理"按钮，系统自动处理数据

4. **查看进度**：实时显示处理进度和状态信息

5. **下载结果**：处理完成后可下载单个文件或所有文件的ZIP包

### 方式2：命令行模式

#### 启动程序
```bash
python3 calculate_scores_final_fix.py
```

#### 操作步骤
1. **直接运行**：程序会自动处理默认文件 `data/2025Mid3.xls`
2. **查看进度**：在终端查看处理进度和详细信息
3. **结果输出**：结果文件保存在当前工作目录

### 方式3：命令行模式

#### 处理所有科目
```bash
python3 calculate_scores_final_fix.py
```

#### 处理指定科目
```bash
python3 -c "
import calculate_scores_final_fix
result = calculate_scores_final_fix.process_single_subject('data/2025Mid3.xls', '语文')
print('处理完成')
"
```

## 📊 输入数据格式要求

### Excel文件结构
- **文件格式**：`.xls` 或 `.xlsx`
- **工作表**：每个科目一个工作表（如：语文、数学、英语等）
- **排除工作表**：`sheet1` 等非科目工作表会被自动忽略

### 必需列名
- `学校代码`：学校标识（支持多种格式：`学校代码`、`学校   代码`等）
- `学校名称`：学校名称（支持多种格式：`学校名称`、`学校  名称`等）
- `班别`：班级信息（支持多种格式：`班别`、`班   别`等）
- `{科目}科任`：对应科目的任课教师（如：语文科任、数学科任）

**智能列名识别**：程序会自动识别和标准化包含空格的列名，确保数据处理的稳定性。

### 考试数据列
程序会自动识别考试名称，支持以下格式：
- **下划线格式**：`{考试名}_{科目}_{指标}_{后缀}`（推荐）
  - 例如：`中考_语文_平均分_p1`
- **空格格式**：`{考试名}   {科目}   {指标}   {后缀}`（兼容）
  - 例如：`中考   语文   平均分   p1`

程序会自动识别并处理两种格式，确保数据兼容性。

## ⚙️ 计算规则

### 赋分规则
- **金山中学**：使用"金山赋分"（如：8.9, 6.9）
- **其他学校**：使用"常规赋分"（如：8, 6）

### 排名区间赋分
根据参与人数动态调整：

#### 参与人数 > 20人
- 1-18名：8分（金山8.9分）
- 19-43名：6分（金山6.9分）
- 44-71名：5分（金山5.9分）
- 72-106名：4分（金山4.9分）
- 107-134名：3分（金山3.9分）
- 135-159名：2分（金山2.9分）
- 160名以后：0分

#### 参与人数 ≤ 20人
- 1-3名：8分（金山8.9分）
- 4-7名：6分（金山6.9分）
- 8-12名：5分（金山5.9分）
- 13-18名：4分（金山4.9分）
- 19-25名：3分（金山3.9分）
- 26-30名：2分（金山2.9分）
- 31名以后：0分

### 指标排序方向
- **正向指标**（高到低排序）：平均分、优秀率、优良率、合格率
- **负向指标**（低到高排序）：低分率

### 差值计算
- **第二次考试**：计算（第一次 - 第二次）的差值
- **第三次考试**：计算（第二次 - 第三次）的差值
- **第四次考试**：计算（第三次 - 第四次）的差值

**智能列名匹配**：程序会自动匹配当前考试和前一个考试的列名，支持多种格式，确保差值计算准确。

### 加权计算

#### 单次考试总分
```
总分 = 平均分得分 × 0.3 + 优秀率得分 × 0.2 + 优良率得分 × 0.2 + 合格率得分 × 0.2 + 低分率得分 × 0.1
```

#### 综合得分
根据考试次数动态调整权重：
- **四次考试**：`F = F1 × 0.4 + F2 × 0.2 + F3 × 0.2 + F4 × 0.2`
- **三次考试**：`F = F1 × 0.4 + F2 × 0.3 + F3 × 0.3`
- **二次考试**：`F = F1 × 0.4 + F2 × 0.6`
- **一次考试**：`F = F1`

## 📁 输出文件

### 文件命名
- 格式：`{科目}排名赋分结果_动态识别版.xlsx`
- 例如：`语文排名赋分结果_动态识别版.xlsx`

### 输出列结构
每个指标列后紧跟对应的排名列和得分列：

```
学校代码 | 学校名称 | 班别 | 语文科任 | 中考_语文_平均分_p1 | 中考_语文_平均分_p1_排名 | 中考_语文_平均分_p1_得分 | ...
```

**完整输出包含**：
- 基础信息列（学校代码、学校名称、班别、科任教师）
- 各考试各指标的原始数据
- 各考试各指标的排名和得分
- 各考试各指标的差值、差值排名、差值得分
- 各考试总分
- 综合得分和综合排名

### 特殊处理
- **金山中学低分率**：不参与排名，得分设为0，但计入总分
- **动态考试识别**：自动识别考试名称和顺序
- **智能数据清洗**：自动标准化列名，处理空格和特殊字符
- **容错处理**：支持多种列名格式，自动匹配和转换

## 🔧 系统要求

### Python环境
- **Python版本**：3.7+
- **推荐版本**：3.9+

### 必需库
```bash
# 基础数据处理库
pip install pandas numpy openpyxl xlrd

# 网页服务库（用于网页界面）
pip install Flask

# 数据清洗模块（内置）
# data_cleaner.py - 智能列名标准化和数据类型转换
```

### 系统兼容性
- **macOS**：✅ 支持（已测试）
- **Windows**：✅ 支持
- **Linux**：✅ 支持

## ❗ 常见问题

### 网页服务问题
如果网页服务无法启动：
1. **端口被占用**：如果看到"Address already in use"错误
   - 等待几秒钟让之前的服务完全停止
   - 或者修改`web_app.py`中的端口号（如改为8081）
   - 在macOS上，端口5000通常被AirPlay占用，建议使用8080

2. **依赖包缺失**：如果看到"ModuleNotFoundError"
   ```bash
   source .venv/bin/activate
   pip install Flask pandas numpy openpyxl xlrd
   ```

3. **虚拟环境未激活**：确保使用正确的Python环境
   ```bash
   source .venv/bin/activate
   python3 web_app.py
   ```

### 数据处理问题
如果数据处理出现错误：
1. **列名不匹配**：检查Excel文件中的列名格式
2. **数据清洗失败**：查看日志输出，确认数据清洗模块是否正常工作
3. **差值计算失败**：检查后续考试的列名是否与第一个考试格式一致
4. **文件格式问题**：确认Excel文件格式和编码

### 性能优化
- 大文件处理可能需要较长时间
- 建议关闭其他程序释放内存
- 确保有足够的磁盘空间
- 数据清洗模块会自动优化内存使用

### 调试和日志
- 程序会输出详细的处理日志，包括列名匹配、数据清洗等信息
- 如果遇到问题，查看日志输出可以帮助诊断问题
- 数据清洗模块会记录所有列名转换过程

## 📞 技术支持

### 错误报告
如遇到问题，请提供：
1. 错误信息截图
2. 输入文件样例
3. 系统环境信息

### 功能建议
欢迎提出改进建议和功能需求

---

**版本**：v2.1  
**更新日期**：2025年8月31日  
**开发者**：廖作东 + AI助手

**主要更新**：
- 修复了后续考试差值计算问题
- 增强了列名匹配的容错性
- 优化了数据清洗模块
- 支持多种列名格式（下划线和空格）
